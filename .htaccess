########################################
# üîê SEGURIDAD B√ÅSICA (tu configuraci√≥n actual)
########################################

# Bloquear acceso a archivos sensibles
<FilesMatch "\.(env|git|yml|log|sql|sh)$">
  Order allow,deny
  Deny from all
</FilesMatch>

# Evitar listado de directorios
Options -Indexes

# Proteger archivos ocultos (.htaccess, .htpasswd, etc.)
<Files ~ "^\.ht">
  Order allow,deny
  Deny from all
</Files>

########################################
# üõ°Ô∏è MEJORAS DE SEGURIDAD ADICIONALES
########################################

# Headers de seguridad avanzados
<IfModule mod_headers.c>
    # Prevenir clickjacking
    Header always append X-Frame-Options SAMEORIGIN
    
    # Prevenir XSS attacks
    Header set X-XSS-Protection "1; mode=block"
    
    # Prevenir MIME type sniffing
    Header set X-Content-Type-Options nosniff
    
    # Pol√≠tica de referrer mejorada
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Content Security Policy b√°sico pero efectivo
    Header set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://cdn.jsdelivr.net https://unpkg.com; img-src 'self' data: https:; connect-src 'self' https:; frame-src https://www.youtube.com https://player.vimeo.com;"
    
    # Ocultar informaci√≥n del servidor
    Header unset Server
    Header unset X-Powered-By
</IfModule>

# Protecci√≥n adicional contra inyecciones
<IfModule mod_rewrite.c>
    RewriteCond %{QUERY_STRING} (eval\(|javascript:|base64_|script\.|<script|GLOBALS|mosConfig) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{QUERY_STRING} (boot\.ini|etc/passwd|self/environ) [NC,OR]
    RewriteCond %{QUERY_STRING} (thumbs?(_editor|open)?|tim(thumb)?)\.php [NC,OR]
    RewriteCond %{QUERY_STRING} (\'|\")(.*)(drop|insert|md5|select|union) [NC]
    RewriteRule .* - [F]
</IfModule>

# Bloquear user agents maliciosos comunes
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|wget|python|nikto|curl|scan|java|winhttp|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (%0A|%0D|%27|%3C|%3E|%00) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (;|<|>|'|"|\)|\(|%0A|%0D|%22|%27|%28|%3C|%3E|%00).*(libwww-perl|wget|python|nikto|curl|scan|java|winhttp|HTTrack|clshttp|archiver|loader|email|harvest|extract|grab|miner) [NC]
    RewriteRule .* - [F]
</IfModule>

########################################
# üöÄ RENDIMIENTO Y OPTIMIZACI√ìN (mejorado)
########################################

# Activar compresi√≥n GZIP mejorada
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/html text/plain text/css application/javascript application/json image/svg+xml image/webp
  
  # Tipos adicionales para mejor compresi√≥n
  AddOutputFilterByType DEFLATE text/xml application/xml application/xhtml+xml
  AddOutputFilterByType DEFLATE application/rss+xml application/atom+xml
  AddOutputFilterByType DEFLATE font/ttf font/otf font/eot font/woff font/woff2
  AddOutputFilterByType DEFLATE application/pdf
  
  # Evitar comprimir archivos ya comprimidos
  SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png|zip|gz|rar|bz2|7z)$ no-gzip dont-vary
</IfModule>

# Cache de archivos est√°ticos mejorado
<IfModule mod_expires.c>
  ExpiresActive On
  
  # Tu configuraci√≥n actual de im√°genes (mantenida)
  <Directory "/home3/ajupam/public_html/images">
    ExpiresActive On
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/ico "access plus 1 year"
  </Directory>
  
  # Cache global para otros recursos
  ExpiresByType text/css "access plus 1 month"
  ExpiresByType application/javascript "access plus 1 month"
  ExpiresByType font/woff2 "access plus 1 year"
  ExpiresByType font/woff "access plus 1 year"
  ExpiresByType font/ttf "access plus 1 year"
  ExpiresByType application/pdf "access plus 1 month"
  
  # Cache espec√≠fico para documentos de sponsors
  <Directory "/home3/ajupam/public_html/assets">
    ExpiresByType application/pdf "access plus 3 months"
  </Directory>
  
  # NO cachear p√°ginas de error (importante)
  <Directory "/home3/ajupam/public_html/error">
    ExpiresActive Off
    Header set Cache-Control "no-cache, no-store, must-revalidate"
    Header set Pragma "no-cache"
    Header set Expires 0
  </Directory>
</IfModule>

# Configuraci√≥n MIME types optimizada
<IfModule mod_mime.c>
    AddType application/javascript .js
    AddType text/css .css
    AddType image/webp .webp
    AddType font/woff2 .woff2
    AddType font/woff .woff
    AddType application/pdf .pdf
    AddType image/svg+xml .svg
</IfModule>

########################################
# üîÅ REDIRECCIONES Y REESCRITURA (tu configuraci√≥n actual)
########################################

# Redirigir HTTP a HTTPS
RewriteEngine On
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}/$1 [R=301,L]

# Redirigir /sponsors/ a su landing
RewriteRule ^sponsors/?$ /sponsors/index.html [L]

# Ocultar extensiones en /sponsors/
RewriteCond %{REQUEST_FILENAME} !-f
RewriteRule ^sponsors/([a-zA-Z0-9_-]+)$ sponsors/$1.html [L]

########################################
# üåê REDIRECCIONES ADICIONALES √öTILES
########################################

# Redirigir URLs antiguas comunes (ajustar seg√∫n necesidad)
# Redirect 301 /old-sponsors.html /sponsors/economicos.html
# Redirect 301 /patrocinadores.html /sponsors/
# Redirect 301 /contacto.html /#contacto

# Redirecci√≥n de trailing slash para consistencia
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} ^(.+)/$
RewriteRule ^(.+)/$ /$1 [R=301,L]

########################################
# ‚ö†Ô∏è P√ÅGINAS DE ERROR PERSONALIZADAS (tu configuraci√≥n actual)
########################################

ErrorDocument 404 /error/404.html
ErrorDocument 403 /error/403.html
ErrorDocument 500 /error/500.html

# Errores adicionales que redirigen a p√°ginas similares
ErrorDocument 401 /error/403.html
ErrorDocument 502 /error/500.html
ErrorDocument 503 /error/500.html
ErrorDocument 504 /error/500.html

########################################
# üõ†Ô∏è CONFIGURACI√ìN PARA MANTENIMIENTO
########################################

# ‚ö†Ô∏è ACTIVAR SOLO CUANDO NECESITES MANTENIMIENTO
# Descomenta las siguientes l√≠neas y agrega tu IP:

# RewriteEngine On
# RewriteCond %{REQUEST_URI} !^/error/maintenance\.html$
# RewriteCond %{REQUEST_URI} !^/images/
# RewriteCond %{REQUEST_URI} !^/css/
# RewriteCond %{REQUEST_URI} !^/js/
# RewriteCond %{REQUEST_URI} !^/assets/
# RewriteCond %{REMOTE_ADDR} !^TU_IP_AQUI$  # Reemplazar con tu IP real
# RewriteRule ^(.*)$ /error/maintenance.html [R=503,L]
# Header always set Retry-After "1800"  # 30 minutos

########################################
# üîí PROTECCIONES ESPEC√çFICAS CPANEL
########################################

# Bloquear acceso a directorios del sistema cPanel
RedirectMatch 404 ^/(cgi-bin|cpanel|webmail|whm|\.well-known)

# Proteger archivos de configuraci√≥n espec√≠ficos
<Files "*.yml">
    Order allow,deny
    Deny from all
</Files>

<Files "*.json">
    Order allow,deny
    Deny from all
</Files>

# Excepciones para archivos necesarios
<Files "manifest.json">
    Order deny,allow
    Allow from all
</Files>

<Files "package.json">
    Order allow,deny
    Deny from all
</Files>

# Proteger archivos de backup
<FilesMatch "\.(bak|backup|old|orig|save)$">
    Order allow,deny
    Deny from all
</FilesMatch>

########################################
# üìß OPTIMIZACIONES ESPEC√çFICAS AJUPAM
########################################

# Configuraci√≥n de zona horaria Argentina
<IfModule mod_env.c>
    SetEnv TZ America/Argentina/Mendoza
</IfModule>

# Headers espec√≠ficos para formularios de contacto
<FilesMatch "\.html$">
    <IfModule mod_headers.c>
        # Permitir env√≠o de formularios a Formspree
        Header set Access-Control-Allow-Origin "https://formspree.io"
        Header set Access-Control-Allow-Methods "POST, GET, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type"
    </IfModule>
</FilesMatch>

# Optimizaci√≥n para archivos de sponsors/dossiers
<Directory "/home3/ajupam/public_html/assets/docs">
    <IfModule mod_headers.c>
        # Forzar descarga de PDFs en lugar de visualizaci√≥n
        Header set Content-Disposition "attachment"
        # Pero permitir visualizaci√≥n inline para ciertos archivos
        <FilesMatch "dossier.*\.pdf$">
            Header set Content-Disposition "inline"
        </FilesMatch>
    </IfModule>
</Directory>

########################################
# üéØ CONFIGURACIONES AVANZADAS
########################################

# Prevenir hotlinking de im√°genes (opcional - activar si hay problemas)
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^https://(www\.)?ajupam\.ar [NC]
# RewriteCond %{HTTP_REFERER} !^https://(www\.)?tandempadel\.pro [NC]
# RewriteRule \.(jpg|jpeg|png|gif|webp)$ - [F]

# L√≠mite de tama√±o de request (protecci√≥n contra ataques)
LimitRequestBody 10485760  # 10MB

# Configuraci√≥n de keep-alive para mejor performance
<IfModule mod_headers.c>
    Header set Connection keep-alive
</IfModule>

# Optimizaci√≥n para shared hosting
<IfModule mod_fcgid.c>
    FcgidMaxRequestLen 10485760
</IfModule>

########################################
# üìù LOGGING Y MONITOREO (opcional)
########################################

# Log de errores personalizado (comentado por defecto)
# ErrorLog /home3/ajupam/logs/error_log
# CustomLog /home3/ajupam/logs/access_log combined

# Registrar solo errores importantes
LogLevel warn